/*******************************************************************************
 *                                                                              *
 *                         Brno University of Technology                        *
 *                       Faculty of Information Technology                      *
 *                                                                              *
 *                 A tone reproduction operator for all luminance               *
 *                   ranges considering human color perception                  *
 * 																			    *
 *                                 Bachelor thesis                              *
 *             Author: Jan Findra [xfindr01 AT stud.fit.vutbr.cz]               *
 *                                    Brno 2024                                 *
 *                                                                              *
 *******************************************************************************/

#include "TMO.h"

class TMOMikamo14 : public TMO
{
public:
	TMOMikamo14();
	virtual ~TMOMikamo14();
	virtual int Transform();
	double getAdaptedRetinalIlluminance();
	std::vector<double> getDiscriminationParams(double I);
	std::vector<double> lambdaAdjust(int cone, double lambdaDiff);
	cv::Mat applyTwoStageModel(std::vector<double> spd, double I);
	std::vector<double> RGBtoSpectrum(double red, double green, double blue);
	double luminanceReduction(double Y, double YLogAvg, double Ymax);

	const static int bins = 72;
	const static int binWidth = 5; // range 390nm to 750nm divided into 72 bins => bin width = 5nm
	const static int colors = 7;
	enum color
	{
		White,
		Cyan,
		Magenta,
		Yellow,
		Red,
		Green,
		Blue
	};

	// 72 bins of 7 colors on range 390nm to 750nm for Smits 1999 RGB to Spectrum conversion
	// generated by the matlab code from https://github.com/colour-science/smits1999
	double color_data[bins][colors] = {
		{0.9994, 0.9751, 0.2171, 0.2584, 0.7066, -0.0298, 0.9760},
		{0.9990, 0.9794, 0.2355, 0.3003, 0.8334, -0.0318, 0.9655},
		{0.9995, 0.9703, 0.2142, 0.2777, 0.6313, -0.0334, 0.9720},
		{1.0013, 0.9721, 0.3887, 0.2994, 0.6520, -0.0105, 0.9561},
		{1.0018, 0.9845, 0.9113, 0.3806, 0.6224, 0.0112, 0.9091},
		{1.0006, 0.9925, 0.9012, 0.2443, 0.6743, -0.0263, 0.9092},
		{1.0008, 0.9922, 0.9414, 0.1521, 0.5648, -0.0235, 0.8897},
		{1.0016, 0.9893, 0.9681, 0.0482, 0.6219, -0.0251, 0.8884},
		{1.0017, 0.9836, 0.9756, 0.0237, 0.7586, -0.0227, 0.8853},
		{1.0013, 0.9887, 0.9928, -0.0292, 0.2722, -0.0369, 0.8850},
		{1.0008, 0.9653, 0.9755, -0.0058, -0.0328, -0.0404, 0.8857},
		{1.0006, 0.9628, 0.9976, -0.0000, -0.2480, -0.0311, 0.9024},
		{1.0020, 0.9587, 0.9767, 0.0020, -0.2510, 0.0103, 0.8837},
		{1.0008, 0.9615, 0.9866, 0.0764, -0.1679, 0.0335, 0.8836},
		{1.0014, 0.9684, 1.0040, 0.0569, -0.1692, 0.0750, 0.8858},
		{1.0013, 0.9807, 0.9846, 0.1002, -0.2675, 0.1357, 0.8957},
		{1.0011, 0.9777, 0.9171, 0.1675, -0.2103, 0.2082, 0.8885},
		{0.9998, 0.9845, 0.9209, 0.2122, -0.2075, 0.2919, 0.8936},
		{0.9998, 0.9957, 0.8055, 0.3464, -0.2446, 0.3824, 0.9316},
		{1.0007, 0.9985, 0.5175, 0.4405, -0.1837, 0.4772, 0.9111},
		{1.0001, 0.9994, 0.5928, 0.4954, -0.2100, 0.5703, 0.8782},
		{1.0010, 0.9968, 0.4076, 0.5450, -0.2768, 0.6606, 0.8255},
		{0.9990, 0.9977, 0.1033, 0.6066, -0.2334, 0.7438, 0.7530},
		{0.9981, 0.9979, -0.0362, 0.8987, -0.2330, 0.8167, 0.3213},
		{0.9966, 0.9957, -0.0580, 0.9980, -0.1850, 0.8789, 0.0598},
		{0.9962, 0.9847, 0.0166, 0.9725, -0.1608, 0.9266, -0.0726},
		{0.9989, 0.9977, 0.0361, 0.9419, -0.2517, 0.9630, 0.0006},
		{0.9989, 0.9943, -0.0087, 0.9828, -0.1897, 0.9851, -0.0460},
		{0.9980, 0.9989, 0.0075, 0.9900, -0.2224, 0.9910, -0.0606},
		{1.0000, 0.9979, -0.0380, 0.9861, -0.2311, 0.9995, -0.0000},
		{0.9996, 0.9865, -0.0405, 0.9852, -0.2318, 0.9967, -0.0414},
		{1.0010, 0.9952, -0.0410, 0.9874, -0.2805, 0.9945, -0.0544},
		{0.9998, 0.9905, -0.0169, 0.9913, -0.1254, 0.9902, -0.0463},
		{1.0009, 0.9966, 0.0059, 0.9848, 0.5486, 0.9791, -0.0057},
		{0.9990, 0.9967, -0.0118, 0.9913, 0.5297, 0.9649, -0.0075},
		{1.0009, 0.9671, -0.0200, 0.9941, 0.5557, 0.9614, -0.0403},
		{1.0004, 0.9257, 0.0364, 0.9932, 0.6620, 0.9491, 0.0034},
		{0.9997, 0.8478, 0.2153, 0.9915, 0.5765, 0.7988, -0.0759},
		{1.0008, 0.8103, 0.4798, 0.9858, 0.6076, 0.6535, -0.0366},
		{1.0007, 0.5934, 0.7404, 0.9885, 0.7023, 0.5134, -0.0549},
		{1.0008, 0.4266, 0.9159, 0.9928, 0.6290, 0.3811, -0.0691},
		{1.0005, 0.2703, 0.9704, 0.9828, 0.7426, 0.2668, -0.0532},
		{0.9976, 0.1440, 0.9915, 0.9944, 0.7966, 0.1680, -0.0798},
		{0.9969, 0.0384, 0.9755, 0.9924, 0.7419, 0.0848, -0.0824},
		{0.9985, -0.0466, 0.9869, 0.9934, 0.7614, 0.0240, 0.0057},
		{0.9993, -0.0237, 0.9910, 0.9842, 0.7926, -0.0215, 0.0746},
		{0.9982, -0.0548, 0.9233, 0.9839, 0.7593, -0.0314, 0.0513},
		{0.9977, -0.0568, 0.9643, 0.9859, 0.5141, -0.0365, 0.0669},
		{1.0003, 0.0153, 0.9350, 0.9831, 0.5897, -0.0317, 0.1693},
		{0.9995, -0.0359, 0.9386, 0.9864, 0.5669, -0.0283, 0.2252},
		{0.9993, -0.0549, 0.8361, 0.9827, 0.7962, -0.0291, 0.2127},
		{0.9991, -0.0463, 0.7392, 0.9765, 0.7543, -0.0275, 0.2596},
		{1.0004, -0.0371, 0.5637, 0.9842, 0.6751, -0.0307, 0.3008},
		{0.9965, -0.0235, 0.4023, 0.9800, 0.7868, -0.0384, 0.3147},
		{1.0000, 0.0000, 0.3614, 0.9690, 0.7805, -0.0394, 0.3647},
		{0.9987, -0.0240, 0.2880, 0.9796, 0.7493, -0.0336, 0.4075},
		{1.0005, -0.0260, 0.3414, 0.9835, 0.7606, -0.0203, 0.3403},
		{1.0012, -0.0288, 0.4626, 0.9695, 0.7504, -0.0366, 0.3951},
		{1.0011, -0.0365, 0.5459, 0.9351, 0.6364, -0.0231, 0.3724},
		{1.0008, -0.0353, 0.6902, 0.9578, 0.5482, -0.0097, 0.3227},
		{1.0010, -0.0168, 0.7477, 0.9502, 0.5197, 0.0036, 0.3147},
		{1.0008, 0.0008, 0.7792, 0.9679, 0.6367, 0.0173, 0.3365},
		{1.0009, 0.0242, 0.7288, 0.9496, 0.4496, 0.0124, 0.2619},
		{1.0005, 0.0240, 0.7116, 0.9308, 0.4726, 0.0045, 0.2853},
		{1.0001, 0.0156, 0.4716, 0.8689, 0.4786, -0.0027, 0.2941},
		{0.9994, 0.0185, 0.5982, 0.8038, 0.5795, -0.0048, 0.3559},
		{0.9976, 0.0154, 0.5010, 0.6610, 0.5977, -0.0042, 0.3741},
		{0.9975, -0.0112, 0.5189, 0.5459, 0.7111, -0.0024, 0.4045},
		{0.9988, -0.0187, 0.5144, 0.4365, 0.4732, -0.0022, 0.3517},
		{0.9983, -0.0202, 0.5265, 0.5623, 0.3060, -0.0030, 0.3758},
		{0.9991, -0.0075, 0.4680, 0.4378, 0.0961, -0.0021, 0.3529},
		{1.0002, -0.0088, 0.4855, 0.5450, -0.0421, -0.0023, 0.3041}};

	// 72 bins of 3 cone's spectral sensitivities on range 390nm to 750nm
	// data from http://www.cvrl.org/
	double LMSsensitivities[bins][3] = {
		{4.07619E-04, 3.58227E-04, 6.14265E-03},
		{1.06921E-03, 9.64828E-04, 1.59515E-02},
		{2.54073E-03, 2.37208E-03, 3.96308E-02},
		{5.31546E-03, 5.12316E-03, 8.97612E-02},
		{9.98835E-03, 9.98841E-03, 1.78530E-01},
		{1.60130E-02, 1.72596E-02, 3.05941E-01},
		{2.33957E-02, 2.73163E-02, 4.62692E-01},
		{3.09104E-02, 3.96928E-02, 6.09570E-01},
		{3.97810E-02, 5.55384E-02, 7.56885E-01},
		{4.94172E-02, 7.50299E-02, 8.69984E-01},
		{5.94619E-02, 9.57612E-02, 9.66960E-01},
		{6.86538E-02, 1.16220E-01, 9.93336E-01},
		{7.95647E-02, 1.39493E-01, 9.91329E-01},
		{9.07704E-02, 1.62006E-01, 9.06735E-01},
		{1.06663E-01, 1.93202E-01, 8.23726E-01},
		{1.28336E-01, 2.32275E-01, 7.37043E-01},
		{1.51651E-01, 2.71441E-01, 6.10456E-01},
		{1.77116E-01, 3.10372E-01, 4.70894E-01},
		{2.07940E-01, 3.55066E-01, 3.50108E-01},
		{2.44046E-01, 4.05688E-01, 2.58497E-01},
		{2.82752E-01, 4.56137E-01, 1.85297E-01},
		{3.34786E-01, 5.22970E-01, 1.35351E-01},
		{3.91705E-01, 5.91003E-01, 9.67990E-02},
		{4.56252E-01, 6.66404E-01, 6.49614E-02},
		{5.26538E-01, 7.43612E-01, 4.12337E-02},
		{5.99867E-01, 8.16808E-01, 2.71300E-02},
		{6.75313E-01, 8.89214E-01, 1.76298E-02},
		{7.37108E-01, 9.34977E-01, 1.13252E-02},
		{7.88900E-01, 9.61962E-01, 7.17089E-03},
		{8.37403E-01, 9.81481E-01, 4.54287E-03},
		{8.90871E-01, 9.98931E-01, 2.83352E-03},
		{9.26660E-01, 9.91383E-01, 1.75573E-03},
		{9.44527E-01, 9.61876E-01, 1.08230E-03},
		{9.70703E-01, 9.35829E-01, 6.64512E-04},
		{9.85636E-01, 8.90949E-01, 4.08931E-04},
		{9.96979E-01, 8.40969E-01, 2.51918E-04},
		{9.99543E-01, 7.76526E-01, 1.55688E-04},
		{9.87057E-01, 7.00013E-01, 9.67045E-05},
		{9.57841E-01, 6.11728E-01, 6.04705E-05},
		{9.39781E-01, 5.31825E-01, 3.81202E-05},
		{9.06693E-01, 4.54142E-01, 2.42549E-05},
		{8.59605E-01, 3.76527E-01, 1.55924E-05},
		{8.03173E-01, 3.04378E-01, 1.01356E-05},
		{7.40680E-01, 2.39837E-01, 6.66657E-06},
		{6.68991E-01, 1.85104E-01, 4.43906E-06},
		{5.93248E-01, 1.40431E-01, 2.99354E-06},
		{5.17449E-01, 1.04573E-01, 0},
		{4.45125E-01, 7.65841E-02, 0},
		{3.69168E-01, 5.54990E-02, 0},
		{3.00316E-01, 3.97097E-02, 0},
		{2.42316E-01, 2.80314E-02, 0},
		{1.93730E-01, 1.94366E-02, 0},
		{1.49509E-01, 1.37660E-02, 0},
		{1.12638E-01, 9.54315E-03, 0},
		{8.38077E-02, 6.50455E-03, 0},
		{6.16384E-02, 4.42794E-03, 0},
		{4.48132E-02, 3.06050E-03, 0},
		{3.21660E-02, 2.11596E-03, 0},
		{2.27738E-02, 1.45798E-03, 0},
		{1.58939E-02, 9.98424E-04, 0},
		{1.09123E-02, 6.77653E-04, 0},
		{7.59453E-03, 4.67870E-04, 0},
		{5.28607E-03, 3.25278E-04, 0},
		{3.66675E-03, 2.25641E-04, 0},
		{2.51327E-03, 1.55286E-04, 0},
		{1.72108E-03, 1.07388E-04, 0},
		{1.18900E-03, 7.49453E-05, 0},
		{8.22396E-04, 5.24748E-05, 0},
		{5.72917E-04, 3.70443E-05, 0},
		{3.99670E-04, 2.62088E-05, 0},
		{2.78553E-04, 1.85965E-05, 0},
		{1.96528E-04, 1.33965E-05, 0}};

protected:
	TMODouble ari; // adapted retinal illuminance
	TMODouble al;  // average luminance
};
